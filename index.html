<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ§… Bank Cebuli</title>

<style>
*{box-sizing:border-box}
body{
  font-family:Arial,Helvetica,sans-serif;
  background:#f2f4f8;
  margin:0;
}
.container{
  max-width:420px;
  margin:auto;
  padding:15px;
}
.card{
  background:#fff;
  padding:20px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
  margin-bottom:15px;
}
h1,h2{
  text-align:center;
  color:#003087;
}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:10px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:16px;
}
button{
  background:#0070e0;
  color:#fff;
  border:none;
  cursor:pointer;
}
button:hover{background:#005bb5}
.logout{background:#ccc;color:#000}
.saldo{
  font-size:36px;
  text-align:center;
  font-weight:bold;
}
.small{
  text-align:center;
  font-size:13px;
  color:#666;
}
#app{display:none}
</style>
</head>
<body>

<div class="container">

<div id="auth" class="card">
<h1>ðŸ§… Bank Cebuli</h1>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="HasÅ‚o">
<button onclick="register()">Rejestracja</button>
<button onclick="login()">Logowanie</button>
<p id="msg" class="small"></p>
</div>

<div id="app">

<div class="card">
<h2>Saldo</h2>
<div class="saldo"><span id="saldo">0</span> ðŸ§…</div>
<p id="userEmail" class="small"></p>
</div>

<div class="card">
<h2>Przelew</h2>
<select id="users"></select>
<input id="amount" type="number" min="1" placeholder="IloÅ›Ä‡ cebul">
<button onclick="send()">WyÅ›lij</button>
<p id="transferMsg" class="small"></p>
</div>

<div class="card">
<button class="logout" onclick="logout()">Wyloguj</button>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  collection,
  getDocs,
  runTransaction
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBZRmANw06xJYdYnGbC2l_XcEnGy9UiVNM",
  authDomain: "cebula-8d0d5.firebaseapp.com",
  projectId: "cebula-8d0d5",
  storageBucket: "cebula-8d0d5.firebasestorage.app",
  messagingSenderId: "585390317442",
  appId: "1:585390317442:web:7ce7285161574fbfac399b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const authDiv = document.getElementById("auth");
const appDiv = document.getElementById("app");
const saldoSpan = document.getElementById("saldo");
const usersSelect = document.getElementById("users");
const userEmail = document.getElementById("userEmail");
const msg = document.getElementById("msg");
const transferMsg = document.getElementById("transferMsg");

window.register = async () => {
  try{
    const cred = await createUserWithEmailAndPassword(
      auth, email.value, password.value
    );
    await setDoc(doc(db,"bankCebuli",cred.user.uid),{
      email: cred.user.email,
      cebule: 100
    });
  }catch(e){ msg.textContent=e.message; }
};

window.login = async () => {
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch(e){ msg.textContent=e.message; }
};

window.logout = ()=>signOut(auth);

onAuthStateChanged(auth, async user=>{
  if(user){
    authDiv.style.display="none";
    appDiv.style.display="block";
    userEmail.textContent=user.email;
    await loadSaldo();
    await loadUsers();
  }else{
    authDiv.style.display="block";
    appDiv.style.display="none";
  }
});

async function loadSaldo(){
  const snap = await getDoc(doc(db,"bankCebuli",auth.currentUser.uid));
  saldoSpan.textContent = snap.data().cebule;
}

async function loadUsers(){
  usersSelect.innerHTML="";
  const snaps = await getDocs(collection(db,"bankCebuli"));
  snaps.forEach(d=>{
    if(d.id !== auth.currentUser.uid){
      const o=document.createElement("option");
      o.value=d.id;
      o.textContent=d.data().email;
      usersSelect.appendChild(o);
    }
  });
}

window.send = async ()=>{
  transferMsg.textContent="";
  const amount = Number(document.getElementById("amount").value);
  if(amount<=0) return;

  const fromRef = doc(db,"bankCebuli",auth.currentUser.uid);
  const toRef = doc(db,"bankCebuli",usersSelect.value);

  try{
    await runTransaction(db, async (tx)=>{
      const fromSnap = await tx.get(fromRef);
      const toSnap = await tx.get(toRef);

      if(fromSnap.data().cebule < amount){
        throw "Brak Å›rodkÃ³w";
      }

      tx.update(fromRef,{
        cebule: fromSnap.data().cebule - amount
      });
      tx.update(toRef,{
        cebule: toSnap.data().cebule + amount
      });
    });

    transferMsg.textContent="Przelew wykonany âœ”ï¸";
    loadSaldo();

  }catch(e){
    transferMsg.textContent="BÅ‚Ä…d przelewu";
  }
};
</script>

</body>
</html>

